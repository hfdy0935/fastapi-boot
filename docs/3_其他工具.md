**一些工具和实践**

:hammer:**中间件**
:one: `HTTP`中间件
```py

from collections.abc import Callable
from fastapi import Request
from fastapi_boot.core import Controller, Get, use_http_middleware


async def middleware(request: Request, call_next: Callable):
    print('middleware之前')
    ans = await call_next(request)
    print('middleware之后')
    return ans


@Controller('/middleware')
class MiddlewareController:
    _ = use_http_middleware(middleware)

    @Get()
    def raise_error(self):
        print('endpoint中')
        return 'ok'
```


:two: `WebSocket`中间件

```py
from collections.abc import Callable, Coroutine
from fastapi import WebSocket
from fastapi_boot.core import Controller, WS, use_ws_middleware

async def middleware1(websocket: WebSocket, call_next: Callable[[WebSocket], Coroutine]):
    print('before middleware1')
    await call_next(websocket)
    print('after middleware1')


async def middleware2(websocket: WebSocket, call_next: Callable[[WebSocket], Coroutine]):
    print('before middleware2')
    await call_next(websocket)
    print('after middleware2')


@Controller('/middleware')
class UserController:
    # only_message:是否仅有消息时才拦截，为False时连接等事件也会拦截
    _ = use_ws_middleware(middleware1, middleware2, only_message=True)

    @WS()
    async def f(self, websocket: WebSocket):
        try:
            await websocket.accept()
            while True:
                data = await websocket.receive_json()
                await websocket.send_json(data)
        except:
            pass
```


:hammer:**子项目**

**可以用`app.mount`挂载子项目，它们的依赖是全局共享的**

```js
.
├── main.py
└── modules
    ├── user1
    │   ├── app.py
    │   └── controller.py
    └── user2
        ├── app.py
        └── controller.py
```

:one: `main.py`
```py
from fastapi import FastAPI
import uvicorn
from modules.user1.app import app as app1
from modules.user2.app import app as app2

app = FastAPI()
app.mount('/user1', app1)
app.mount('/user2', app2)


if __name__ == '__main__':
    uvicorn.run('main:app', reload=True)
```

:two: `modules.user1.app.py`
```py
from fastapi_boot.core import provide_app
from modules.user1.controller import UserController

app = provide_app(controllers=[UserController])
```

:three: `modules.user1.controller.py`
```py
from fastapi_boot.core import Controller, Get


@Controller('/user')
class UserController:
    @Get()
    def fn(self):
        return 'user1'
```

:four: `modules.UserControlle2.app.py`
```py
from fastapi_boot.core import provide_app
from modules.user2.controller import UserController

app = provide_app(controllers=[UserController])
```

:five: `modules.UserControlle2.controller.py`
```py
from fastapi_boot.core import Controller, Get


@Controller('/user')
class UserController:
    @Get()
    def fn(self):
        return 'user2'
```